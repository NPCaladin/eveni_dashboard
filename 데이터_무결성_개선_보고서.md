# 📊 데이터 무결성 개선 보고서

## 🔴 발견된 문제

### 1. **대규모 report_id 누락** (심각)
- **전체 1000건 중 983건이 report_id = NULL**
- 12월 2주차 17건만 정상, 나머지 모두 NULL
- 원인: 기존 데이터는 report_id 없이 업로드됨

### 2. **과거 결제 + 현재 환불 처리 오류** (중요)
- **101건의 과거 결제 + 최근 환불 케이스**
- 예: 10월 결제 → 12월 환불
- 문제: 삭제 로직이 이런 케이스를 잘못 처리

### 3. **12월 2주차 데이터 불일치**
- **엑셀 원본**: 실매출 55,927,000원, 환불 6건 18,605,388원
- **대시보드**: 실매출 50,384,000원, 환불 5건 10,962,388원
- **차이**:
  - 양희원22 (5,543,000원) 누락 - 날짜 필드 오류
  - 고숙정94 (7,643,000원) 삭제됨 - 잘못된 삭제 로직

---

## ✅ 해결 방안

### 1단계: 과거 데이터 report_id 복구 (필수)

**`report_id_fix.sql` 파일 생성 완료**
- 969건의 거래에 자동 매칭된 report_id
- 31건은 주차 매칭 실패 (2023년 8~12월 데이터)

**실행 방법:**
```sql
-- Supabase SQL Editor에서 report_id_fix.sql 내용 실행
-- 주차별로 그룹핑되어 있음
-- 예시:
UPDATE sales_transactions
SET report_id = '337f6246-d4ef-4a7b-a3a2-f7d0fe265a87'
WHERE id IN ('83f9c01a-c36b-4610-ae16-5ede93c66fdc');
```

### 2단계: 업로드 로직 개선 (완료)

**개선된 삭제 로직:**
```javascript
// 1. report_id로 삭제 (같은 주차 모든 거래)
// 2. 결제일 기준 + status='결' + report_id NULL (결제 중복 제거)
// 3. 환불일 기준 + status='환' + 결제일이 주차 밖 + report_id NULL (과거 결제 환불)
```

**개선 사항:**
- ✅ 과거 결제 + 현재 환불 케이스 올바르게 처리
- ✅ report_id NULL인 오래된 중복 데이터 자동 제거
- ✅ 환불일 기준으로 환불 데이터 매칭

### 3단계: 12월 2주차 재업로드 (필요)

**작업 순서:**
1. 1단계 완료 후
2. 어드민 > 교육사업본부
3. 12월 2주차 선택
4. `2025_12_2week_cleaned.xlsx` 재업로드

**기대 결과:**
- ✅ 실매출: 55,927,000원 (양희원22 포함)
- ✅ 환불: 6건, 18,605,388원 (고숙정94 포함)
- ✅ 순매출: 37,321,612원

---

## 📋 실행 체크리스트

### [ ] 1단계: report_id 복구
```bash
# 1. report_id_fix.sql 파일 확인
# 2. Supabase SQL Editor 접속
# 3. 파일 내용 복사/붙여넣기 후 실행
# 4. 완료 후 검증
```

### [ ] 2단계: 서버 재시작
```bash
# 터미널에서:
# Ctrl + C
# npm run dev
```

### [ ] 3단계: 12월 2주차 재업로드
```
1. 어드민 페이지 접속
2. 교육사업본부 탭
3. 주차 선택: 12월 2주차
4. 엑셀 업로드: 2025_12_2week_cleaned.xlsx
5. 업로드 완료 확인
```

### [ ] 4단계: 대시보드 검증
```
1. 대시보드 > 교육사업본부
2. 12월 2주차 선택
3. 수치 확인:
   - 실매출: 55,927,000원
   - 환불: 6건, 18,605,388원
   - 순매출: 37,321,612원
```

---

## 🔍 주차별 데이터 상태 (최근 5개)

| 주차 | 결제일 기준 | report_id 기준 | 환불 | 상태 |
|------|------------|---------------|------|------|
| 12월 2주차 | 16건 | 17건 | 5건 | ⚠️ 불일치 |
| 12월 1주차 | 8건 | 0건 | 1건 | ❌ report_id 없음 |
| 11월 4주차 | 14건 | 0건 | 2건 | ❌ report_id 없음 |
| 11월 3주차 | 11건 | 0건 | 4건 | ❌ report_id 없음 |
| 11월 2주차 | 6건 | 0건 | 2건 | ❌ report_id 없음 |

---

## 💡 장기 개선 사항

### 1. 필수 필드 검증 강화
- 날짜 필드 필수 체크
- 다양한 날짜 형식 지원
- 업로드 전 데이터 검증

### 2. 데이터 무결성 모니터링
- report_id NULL 알림
- 주차별 데이터 개수 검증
- 자동 백업 시스템

### 3. 관리자 도구 개선
- 데이터 검증 대시보드
- 누락 데이터 자동 감지
- 일괄 복구 기능

---

## 📞 문의사항

문제 발생 시:
1. 터미널 로그 확인
2. Supabase 로그 확인
3. `validate_all_data.js` 실행하여 상태 확인





